<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Panel de Control - Ascensor 3 Pisos</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* RESET Y ESTILOS BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            height: calc(100vh - 40px);
        }

        /* PANEL IZQUIERDO - MENSAJES FIREBASE */
        .panel-mensajes {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #00b4d8;
        }

        .panel-header h1 {
            font-size: 1.8rem;
            color: #00b4d8;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .panel-header h1 i {
            font-size: 1.5rem;
        }

        .subtitle {
            color: #90e0ef;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border-left: 4px solid #00b4d8;
            min-width: 180px;
        }

        .status-icon {
            font-size: 1.3rem;
            color: #00b4d8;
        }

        .status-info {
            display: flex;
            flex-direction: column;
        }

        .status-label {
            font-size: 0.8rem;
            color: #90e0ef;
            opacity: 0.8;
        }

        .status-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        #connectionStatus {
            color: #4cc9f0;
        }

        .mensajes-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .mensajes-container::-webkit-scrollbar {
            width: 8px;
        }

        .mensajes-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .mensajes-container::-webkit-scrollbar-thumb {
            background: #00b4d8;
            border-radius: 10px;
        }

        .mensaje-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 18px;
            margin-bottom: 15px;
            border-radius: 12px;
            border-left: 5px solid #00b4d8;
            animation: fadeIn 0.5s ease;
            transition: all 0.3s ease;
        }

        .mensaje-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.08);
        }

        .mensaje-item.emergencia {
            border-left-color: #ff0054;
            background: rgba(255, 0, 84, 0.1);
            animation: pulse 2s infinite;
        }

        .mensaje-item.movimiento {
            border-left-color: #4cc9f0;
        }

        .mensaje-item.puerta {
            border-left-color: #38b000;
        }

        .mensaje-item.inicio {
            border-left-color: #ff9e00;
        }

        .mensaje-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #90e0ef;
        }

        .mensaje-time {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mensaje-content {
            font-size: 1rem;
            line-height: 1.5;
            word-break: break-word;
        }

        /* PANEL DERECHO - SIMULACIN DEL ASCENSOR */
        .panel-simulacion {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .simulacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ff0054;
        }

        .simulacion-header h2 {
            font-size: 1.8rem;
            color: #ff0054;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .estado-actual {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4cc9f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ESTRUCTURA DEL ASCENSOR */
        .estructura-ascensor {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .edificio {
            width: 400px;
            height: 600px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.8),
                0 0 0 4px #222831,
                0 10px 40px rgba(0, 0, 0, 0.5);
        }

        /* ESTRUCTURA METLICA */
        .estructura-metalica {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .tubo-vertical {
            position: absolute;
            width: 8px;
            height: 100%;
            background: linear-gradient(to bottom, #4a4e69 0%, #222831 50%, #4a4e69 100%);
            left: 50px;
            box-shadow: 
                inset 0 0 10px rgba(0, 0, 0, 0.5),
                0 0 10px rgba(0, 0, 0, 0.3);
        }

        .tubo-vertical:nth-child(2) {
            left: 350px;
        }

        .tubo-horizontal {
            position: absolute;
            height: 8px;
            width: 300px;
            background: linear-gradient(to right, #4a4e69 0%, #222831 50%, #4a4e69 100%);
            left: 50px;
            box-shadow: 
                inset 0 0 10px rgba(0, 0, 0, 0.5),
                0 0 10px rgba(0, 0, 0, 0.3);
        }

        .tubo-horizontal:nth-child(1) { top: 0; }
        .tubo-horizontal:nth-child(2) { top: 200px; }
        .tubo-horizontal:nth-child(3) { top: 400px; }
        .tubo-horizontal:nth-child(4) { top: 600px; }

        /* PISOS DEL EDIFICIO */
        .piso {
            position: absolute;
            width: 100%;
            height: 200px;
            border-bottom: 3px solid #222831;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .piso:nth-child(1) { top: 0; }
        .piso:nth-child(2) { top: 200px; }
        .piso:nth-child(3) { top: 400px; }

        .numero-piso {
            position: absolute;
            left: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            color: #00b4d8;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid #00b4d8;
        }

        .indicador-llamada {
            position: absolute;
            right: 30px;
            width: 20px;
            height: 20px;
            background: #00b4d8;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 15px #00b4d8;
        }

        .indicador-llamada.activo {
            opacity: 1;
            animation: parpadeo 1s infinite;
        }

        /* CABINA DEL ASCENSOR */
        .cabina-container {
            position: absolute;
            width: 250px;
            height: 160px;
            left: 75px;
            bottom: 20px;
            transition: bottom 2s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 2;
        }

        .cabina {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 5px 25px rgba(76, 201, 240, 0.4),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.2);
            transition: all 0.5s ease;
        }

        .cabina.emergencia {
            background: linear-gradient(135deg, #ff0054 0%, #ff4d6d 100%);
            animation: parpadeo-emergencia 1s infinite;
            box-shadow: 
                0 5px 25px rgba(255, 0, 84, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .cabina.moviendose {
            animation: vibracion 0.2s infinite;
        }

        /* PUERTAS DE LA CABINA */
        .puertas {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            overflow: hidden;
            border-radius: 6px;
        }

        .puerta {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(135deg, #48cae4 0%, #0096c7 100%);
            transition: transform 1s ease-in-out;
            box-shadow: 
                inset 0 0 10px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .puerta.emergencia {
            background: linear-gradient(135deg, #ff4d6d 0%, #c9184a 100%);
        }

        .puerta-izquierda {
            left: 0;
            transform-origin: left;
            border-right: 1px solid rgba(0, 0, 0, 0.3);
        }

        .puerta-derecha {
            right: 0;
            transform-origin: right;
            border-left: 1px solid rgba(0, 0, 0, 0.3);
        }

        .puertas.abiertas .puerta-izquierda {
            transform: translateX(-100%);
        }

        .puertas.abiertas .puerta-derecha {
            transform: translateX(100%);
        }

        .puertas.cerrando .puerta-izquierda,
        .puertas.cerrando .puerta-derecha {
            transition: transform 2s ease-in-out;
        }

        /* PANEL INTERNO DE LA CABINA */
        .panel-cabina {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 180px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            z-index: 3;
        }

        .display-piso {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .display-estado {
            font-size: 1rem;
            color: #90e0ef;
            font-weight: 600;
            min-height: 24px;
        }

        .display-destino {
            font-size: 0.9rem;
            color: #ffd60a;
            margin-top: 5px;
        }

        /* CONTROLES DEL PANEL */
        .controles-simulacion {
            margin-top: 25px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .grupo-controles {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .grupo-titulo {
            font-size: 1rem;
            color: #00b4d8;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .botones-controles {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .btn-control {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-control:hover {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4);
        }

        .btn-control:active {
            transform: translateY(0);
        }

        .btn-control.emergencia {
            background: linear-gradient(135deg, #ff0054 0%, #c9184a 100%);
            grid-column: span 3;
            margin-top: 10px;
        }

        .btn-control.emergencia:hover {
            background: linear-gradient(135deg, #ff4d6d 0%, #ff0054 100%);
            box-shadow: 0 5px 15px rgba(255, 0, 84, 0.4);
        }

        .btn-control.activo {
            background: linear-gradient(135deg, #38b000 0%, #2d7d46 100%);
            box-shadow: 0 0 15px rgba(56, 176, 0, 0.5);
        }

        /* ANIMACIONES */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 84, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 84, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 84, 0); }
        }

        @keyframes parpadeo {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes parpadeo-emergencia {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes vibracion {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(1px); }
            75% { transform: translateX(-1px); }
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .panel-mensajes, .panel-simulacion {
                min-height: 700px;
            }
            
            .edificio {
                width: 350px;
                height: 500px;
            }
            
            .piso {
                height: 166px;
            }
        }

        @media (max-width: 768px) {
            .status-bar {
                flex-direction: column;
            }
            
            .controles-simulacion {
                grid-template-columns: 1fr;
            }
            
            .edificio {
                width: 100%;
                max-width: 350px;
                height: 400px;
            }
            
            .cabina-container {
                width: 200px;
                height: 130px;
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- PANEL IZQUIERDO - MENSAJES FIREBASE -->
        <div class="panel-mensajes">
            <div class="panel-header">
                <h1><i class="fas fa-database"></i> PANEL DE MONITOREO</h1>
                <div class="subtitle">Mensajes en tiempo real desde el ascensor ESP32</div>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-icon"><i class="fas fa-wifi"></i></div>
                    <div class="status-info">
                        <div class="status-label">CONEXIN</div>
                        <div class="status-value" id="connectionStatus">Conectando...</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon"><i class="fas fa-clock"></i></div>
                    <div class="status-info">
                        <div class="status-label">LTIMA ACTUALIZACIN</div>
                        <div class="status-value" id="lastUpdate">--:--:--</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon"><i class="fas fa-bell"></i></div>
                    <div class="status-info">
                        <div class="status-label">ESTADO SISTEMA</div>
                        <div class="status-value" id="systemStatus">INICIANDO...</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon"><i class="fas fa-elevator"></i></div>
                    <div class="status-info">
                        <div class="status-label">PISO ACTUAL</div>
                        <div class="status-value" id="currentFloor">1</div>
                    </div>
                </div>
            </div>
            
            <div class="mensajes-container" id="mensajesContainer">
                <!-- Los mensajes de Firebase aparecer谩n aqu铆 -->
            </div>
        </div>
        
        <!-- PANEL DERECHO - SIMULACIN DEL ASCENSOR -->
        <div class="panel-simulacion">
            <div class="simulacion-header">
                <h2><i class="fas fa-elevator"></i> SIMULACIN 3D</h2>
                <div class="estado-actual">
                    <i class="fas fa-info-circle"></i>
                    <span id="estadoSimulacion">ESPERANDO INICIO</span>
                </div>
            </div>
            
            <div class="estructura-ascensor">
                <div class="edificio">
                    <!-- Estructura met谩lica -->
                    <div class="estructura-metalica">
                        <div class="tubo-vertical"></div>
                        <div class="tubo-vertical"></div>
                        <div class="tubo-horizontal"></div>
                        <div class="tubo-horizontal"></div>
                        <div class="tubo-horizontal"></div>
                        <div class="tubo-horizontal"></div>
                    </div>
                    
                    <!-- Pisos -->
                    <div class="piso" id="piso3">
                        <div class="numero-piso">3</div>
                        <div class="indicador-llamada" id="llamadaP3"></div>
                    </div>
                    <div class="piso" id="piso2">
                        <div class="numero-piso">2</div>
                        <div class="indicador-llamada" id="llamadaP2"></div>
                    </div>
                    <div class="piso" id="piso1">
                        <div class="numero-piso">1</div>
                        <div class="indicador-llamada" id="llamadaP1"></div>
                    </div>
                    
                    <!-- Cabina del ascensor -->
                    <div class="cabina-container" id="cabinaContainer" style="bottom: 20px;">
                        <div class="cabina" id="cabina">
                            <div class="puertas" id="puertas">
                                <div class="puerta puerta-izquierda"></div>
                                <div class="puerta puerta-derecha"></div>
                            </div>
                            <div class="panel-cabina">
                                <div class="display-piso" id="displayPiso">1</div>
                                <div class="display-estado" id="displayEstado">ESPERANDO</div>
                                <div class="display-destino" id="displayDestino">Destino: --</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controles de simulaci贸n -->
            <div class="controles-simulacion">
                <div class="grupo-controles">
                    <div class="grupo-titulo"><i class="fas fa-door-closed"></i> LLAMADAS EXTERNAS</div>
                    <div class="botones-controles">
                        <button class="btn-control" id="btnCall1">PISO 1</button>
                        <button class="btn-control" id="btnCall2">PISO 2</button>
                        <button class="btn-control" id="btnCall3">PISO 3</button>
                    </div>
                </div>
                
                <div class="grupo-controles">
                    <div class="grupo-titulo"><i class="fas fa-user"></i> RDENES INTERNAS</div>
                    <div class="botones-controles">
                        <button class="btn-control" id="btnInternal1">PISO 1</button>
                        <button class="btn-control" id="btnInternal2">PISO 2</button>
                        <button class="btn-control" id="btnInternal3">PISO 3</button>
                    </div>
                </div>
                
                <div class="grupo-controles">
                    <div class="grupo-titulo"><i class="fas fa-cogs"></i> CONTROLES MANUALES</div>
                    <div class="botones-controles">
                        <button class="btn-control" id="btnOpenDoor"><i class="fas fa-door-open"></i> ABRIR</button>
                        <button class="btn-control" id="btnCloseDoor"><i class="fas fa-door-closed"></i> CERRAR</button>
                        <button class="btn-control emergencia" id="btnEmergency">
                            <i class="fas fa-exclamation-triangle"></i> EMERGENCIA
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // CONFIGURACIN FIREBASE
        // ===============================
        const firebaseConfig = {
            apiKey: "AIzaSyAU31I1rNQCDLxG-ayjKS61uTo6oUuCmCA",
            authDomain: "monitor-ascensor.firebaseapp.com",
            databaseURL: "https://monitor-ascensor-default-rtdb.firebaseio.com",
            projectId: "monitor-ascensor",
            storageBucket: "monitor-ascensor.firebasestorage.app",
            messagingSenderId: "64032364230",
            appId: "1:64032364230:web:8afb090f6debefeccfa9c7"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ===============================
        // VARIABLES DE ESTADO GLOBAL
        // ===============================
        let estadoSistema = {
            pisoActual: 1,
            pisoDestino: null,
            movimiento: 'DETENIDO', // 'DETENIDO', 'SUBIENDO', 'BAJANDO'
            puertas: 'CERRADAS', // 'CERRADAS', 'ABRINDOSE', 'ABIERTAS', 'CERRNDOSE'
            emergencia: false,
            llamadasExternas: [0, 0, 0], // [P1, P2, P3]
            ordenesInternas: [0, 0, 0],
            ultimoMensaje: null,
            conexionActiva: false,
            temporizadorPuertas: null
        };
        
        // ===============================
        // POSICIONES DE LA CABINA (en px)
        // ===============================
        const posicionesPisos = {
            1: 20,   // Piso 1: bottom 20px
            2: 220,  // Piso 2: bottom 220px
            3: 420   // Piso 3: bottom 420px
        };
        
        // ===============================
        // INICIALIZACIN DEL SISTEMA
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            actualizarInterfaz();
            conectarFirebase();
            configurarControles();
            mostrarMensajeInicial();
        });
        
        // ===============================
        // CONEXIN A FIREBASE
        // ===============================
        function conectarFirebase() {
            const mensajesRef = database.ref('messages');
            
            mensajesRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const mensajes = snapshot.val();
                    const mensajesArray = Object.values(mensajes).sort((a, b) => b.ts - a.ts);
                    
                    if (mensajesArray.length > 0) {
                        estadoSistema.conexionActiva = true;
                        document.getElementById('connectionStatus').textContent = 'CONECTADO';
                        document.getElementById('connectionStatus').style.color = '#38b000';
                        
                        // Procesar el mensaje m谩s reciente
                        const ultimoMensaje = mensajesArray[0];
                        procesarMensajeFirebase(ultimoMensaje);
                        
                        // Actualizar panel de mensajes
                        actualizarPanelMensajes(mensajesArray.slice(0, 20));
                        
                        // Actualizar 煤ltima actualizaci贸n
                        const fecha = new Date(ultimoMensaje.ts);
                        document.getElementById('lastUpdate').textContent = fecha.toLocaleTimeString();
                    }
                }
            }, (error) => {
                console.error('Error Firebase:', error);
                document.getElementById('connectionStatus').textContent = 'DESCONECTADO';
                document.getElementById('connectionStatus').style.color = '#ff0054';
                estadoSistema.conexionActiva = false;
            });
        }
        
        // ===============================
        // PROCESAMIENTO DE MENSAJES FIREBASE
        // ===============================
        function procesarMensajeFirebase(mensaje) {
            const texto = mensaje.mensaje || '';
            const piso = mensaje.piso || estadoSistema.pisoActual;
            const estadoCodigo = mensaje.estado || 0;
            
            // Actualizar estado del sistema
            estadoSistema.pisoActual = piso;
            estadoSistema.ultimoMensaje = texto;
            
            // CLASIFICACIN Y PROCESAMIENTO DE MENSAJES
            // ============================================
            
            // 1. MOVIMIENTO - SUBIENDO
            if (texto.includes('[ESTADO_MOVIMIENTO_SUBIENDO]')) {
                const destino = extraerPisoDestino(texto);
                if (destino) {
                    iniciarMovimiento('SUBIENDO', destino);
                }
                estadoSistema.emergencia = false;
                actualizarClaseMensaje('movimiento');
            }
            
            // 2. MOVIMIENTO - BAJANDO
            else if (texto.includes('[ESTADO_MOVIMIENTO_BAJANDO]')) {
                const destino = extraerPisoDestino(texto);
                if (destino) {
                    iniciarMovimiento('BAJANDO', destino);
                }
                estadoSistema.emergencia = false;
                actualizarClaseMensaje('movimiento');
            }
            
            // 3. ACTIVACIN DE MOTOR
            else if (texto.includes('Rel茅 SUBIR = HIGH') || texto.includes('Rel茅 BAJAR = HIGH')) {
                // Confirmaci贸n visual de motor activado
                document.getElementById('cabina').classList.add('moviendose');
                actualizarClaseMensaje('movimiento');
            }
            
            // 4. LLEGADA A PISO
            else if (texto.includes('Llegado a Piso')) {
                const pisoLlegada = extraerPiso(texto);
                if (pisoLlegada) {
                    llegarAPiso(pisoLlegada);
                    
                    // Esperar 0.5s y abrir puertas si indica transici贸n
                    if (texto.includes('Transicion a APERTURA_PUERTAS')) {
                        setTimeout(() => {
                            if (!estadoSistema.emergencia) {
                                iniciarAperturaPuertas();
                            }
                        }, 500);
                    }
                }
            }
            
            // 5. APERTURA DE PUERTAS
            else if (texto.includes('[ESTADO_APERTURA_PUERTAS]')) {
                iniciarAperturaPuertas();
                actualizarClaseMensaje('puerta');
            }
            
            // 6. SECUENCIA DE APERTURA
            else if (texto.includes('Apertura: Activando')) {
                // Puertas abri茅ndose
                estadoSistema.puertas = 'ABRINDOSE';
                document.getElementById('displayEstado').textContent = 'ABRIENDO PUERTAS...';
                actualizarClaseMensaje('puerta');
            }
            else if (texto.includes('Rel茅s de cerradura DESACTIVADOS')) {
                // Puertas totalmente abiertas
                estadoSistema.puertas = 'ABIERTAS';
                document.getElementById('displayEstado').textContent = 'PUERTAS ABIERTAS';
                iniciarTemporizadorCierre(10000);
                actualizarClaseMensaje('puerta');
            }
            else if (texto.includes('Puertas abiertas (esperando)')) {
                // Mantener puertas abiertas
                estadoSistema.puertas = 'ABIERTAS';
                actualizarClaseMensaje('puerta');
            }
            else if (texto.includes('Fin de ventana de puertas')) {
                // Cerrar puertas
                cerrarPuertas();
                actualizarClaseMensaje('puerta');
            }
            
            // 7. EMERGENCIA
            else if (texto.includes('!!! ENTRANDO EN ESTADO_EMERGENCIA')) {
                activarEmergencia();
                actualizarClaseMensaje('emergencia');
            }
            else if (texto.includes('[ESTADO_EMERGENCIA]')) {
                // Mantener estado de emergencia
                estadoSistema.emergencia = true;
                actualizarClaseMensaje('emergencia');
            }
            
            // 8. LLAMADAS EXTERNAS
            else if (texto.includes('Llamada externa agregada')) {
                const pisoLlamada = extraerPiso(texto);
                if (pisoLlamada) {
                    mostrarLlamadaExterna(pisoLlamada);
                }
            }
            
            // 9. RDENES INTERNAS
            else if (texto.includes('Orden INTERNA')) {
                const pisoDestino = extraerPiso(texto);
                if (pisoDestino) {
                    mostrarOrdenInterna(pisoDestino);
                    
                    // Si est谩 detenido, cambiar destino inmediatamente
                    if (estadoSistema.movimiento === 'DETENIDO') {
                        estadoSistema.pisoDestino = pisoDestino;
                        document.getElementById('displayDestino').textContent = `Destino: P${pisoDestino}`;
                    }
                }
            }
            
            // 10. INICIO DEL SISTEMA
            else if (texto.includes('=== INICIO SISTEMA ASCENSOR')) {
                resetearSimulacion();
                actualizarClaseMensaje('inicio');
            }
            else if (texto.includes('=== AUTODIAGNSTICO OK ===')) {
                document.getElementById('systemStatus').textContent = 'OPERATIVO';
                document.getElementById('systemStatus').style.color = '#38b000';
                actualizarClaseMensaje('inicio');
            }
            
            // 11. MOTOR PARADO (contextual)
            else if (texto.includes('Motor PARADO')) {
                // Solo detener si no es llegada y no es emergencia
                if (estadoSistema.movimiento !== 'DETENIDO' && !estadoSistema.emergencia) {
                    detenerMovimiento();
                }
            }
            
            // Actualizar interfaz
            actualizarInterfaz();
        }
        
        // ===============================
        // FUNCIONES DE SIMULACIN
        // ===============================
        
        function iniciarMovimiento(direccion, destino) {
            // Cerrar puertas primero
            cerrarPuertas();
            
            // Configurar estado
            estadoSistema.movimiento = direccion;
            estadoSistema.pisoDestino = destino;
            estadoSistema.emergencia = false;
            
            // Actualizar interfaz
            document.getElementById('cabina').classList.remove('emergencia');
            document.getElementById('cabina').classList.add('moviendose');
            document.getElementById('displayEstado').textContent = `${direccion} A P${destino}`;
            document.getElementById('displayDestino').textContent = `Destino: P${destino}`;
            document.getElementById('estadoSimulacion').textContent = `${direccion} A P${destino}`;
            
            // Mover cabina (animaci贸n)
            const nuevaPosicion = posicionesPisos[destino];
            const cabina = document.getElementById('cabinaContainer');
            cabina.style.transition = 'bottom 3s cubic-bezier(0.34, 1.56, 0.64, 1)';
            cabina.style.bottom = `${nuevaPosicion}px`;
            
            // Quitar animaci贸n de movimiento al llegar
            setTimeout(() => {
                document.getElementById('cabina').classList.remove('moviendose');
            }, 3000);
        }
        
        function llegarAPiso(piso) {
            // Detener movimiento
            estadoSistema.movimiento = 'DETENIDO';
            estadoSistema.pisoActual = piso;
            
            // Posicionar exactamente
            const cabina = document.getElementById('cabinaContainer');
            cabina.style.transition = 'none';
            cabina.style.bottom = `${posicionesPisos[piso]}px`;
            
            // Actualizar displays
            document.getElementById('displayPiso').textContent = piso;
            document.getElementById('currentFloor').textContent = piso;
            document.getElementById('displayEstado').textContent = 'LLEGADO';
            document.getElementById('estadoSimulacion').textContent = `PISO ${piso} - ESPERANDO`;
        }
        
        function iniciarAperturaPuertas() {
            if (estadoSistema.emergencia) return;
            
            estadoSistema.puertas = 'ABRINDOSE';
            const puertas = document.getElementById('puertas');
            
            // Remover clases previas
            puertas.classList.remove('cerrando');
            puertas.classList.add('abiertas');
            
            // Actualizar estado
            document.getElementById('displayEstado').textContent = 'ABRIENDO PUERTAS...';
            document.getElementById('estadoSimulacion').textContent = 'ABRIENDO PUERTAS';
        }
        
        function iniciarTemporizadorCierre(ms) {
            // Limpiar temporizador anterior
            if (estadoSistema.temporizadorPuertas) {
                clearTimeout(estadoSistema.temporizadorPuertas);
            }
            
            // Configurar nuevo temporizador
            estadoSistema.temporizadorPuertas = setTimeout(() => {
                if (!estadoSistema.emergencia) {
                    cerrarPuertas();
                }
            }, ms);
            
            // Mostrar cuenta regresiva
            mostrarCuentaRegresiva(ms / 1000);
        }
        
        function cerrarPuertas() {
            if (estadoSistema.emergencia) return;
            
            estadoSistema.puertas = 'CERRNDOSE';
            const puertas = document.getElementById('puertas');
            
            // Animaci贸n de cierre
            puertas.classList.remove('abiertas');
            puertas.classList.add('cerrando');
            
            document.getElementById('displayEstado').textContent = 'CERRANDO PUERTAS...';
            document.getElementById('estadoSimulacion').textContent = 'CERRANDO PUERTAS';
            
            // Despu茅s de 2 segundos, puertas cerradas
            setTimeout(() => {
                if (!estadoSistema.emergencia) {
                    estadoSistema.puertas = 'CERRADAS';
                    puertas.classList.remove('cerrando');
                    document.getElementById('displayEstado').textContent = 'ESPERANDO';
                    document.getElementById('estadoSimulacion').textContent = 'ESPERANDO';
                }
            }, 2000);
        }
        
        function activarEmergencia() {
            estadoSistema.emergencia = true;
            estadoSistema.movimiento = 'DETENIDO';
            
            // Detener cualquier movimiento
            const cabina = document.getElementById('cabinaContainer');
            cabina.style.transition = 'none';
            
            // Aplicar efectos visuales
            const cabinaElem = document.getElementById('cabina');
            cabinaElem.classList.add('emergencia');
            cabinaElem.classList.remove('moviendose');
            
            // Aplicar emergencia a puertas
            const puertas = document.querySelectorAll('.puerta');
            puertas.forEach(puerta => puerta.classList.add('emergencia'));
            
            // Actualizar displays
            document.getElementById('displayEstado').textContent = ' EMERGENCIA ';
            document.getElementById('displayEstado').style.color = '#ff0054';
            document.getElementById('estadoSimulacion').textContent = 'EMERGENCIA ACTIVADA';
            document.getElementById('systemStatus').textContent = 'EMERGENCIA';
            document.getElementById('systemStatus').style.color = '#ff0054';
            
            // Limpiar temporizador
            if (estadoSistema.temporizadorPuertas) {
                clearTimeout(estadoSistema.temporizadorPuertas);
            }
        }
        
        function resetearSimulacion() {
            // Resetear estado
            estadoSistema = {
                pisoActual: 1,
                pisoDestino: null,
                movimiento: 'DETENIDO',
                puertas: 'CERRADAS',
                emergencia: false,
                llamadasExternas: [0, 0, 0],
                ordenesInternas: [0, 0, 0],
                ultimoMensaje: null,
                conexionActiva: estadoSistema.conexionActiva,
                temporizadorPuertas: null
            };
            
            // Resetear posici贸n cabina
            const cabina = document.getElementById('cabinaContainer');
            cabina.style.transition = 'none';
            cabina.style.bottom = '20px';
            
            // Resetear puertas
            const puertas = document.getElementById('puertas');
            puertas.classList.remove('abiertas', 'cerrando');
            
            // Resetear cabina
            const cabinaElem = document.getElementById('cabina');
            cabinaElem.classList.remove('emergencia', 'moviendose');
            
            // Resetear displays
            document.getElementById('displayPiso').textContent = '1';
            document.getElementById('displayEstado').textContent = 'ESPERANDO';
            document.getElementById('displayEstado').style.color = '';
            document.getElementById('displayDestino').textContent = 'Destino: --';
            document.getElementById('currentFloor').textContent = '1';
            document.getElementById('estadoSimulacion').textContent = 'ESPERANDO INICIO';
            document.getElementById('systemStatus').textContent = 'INICIANDO...';
            document.getElementById('systemStatus').style.color = '';
            
            // Limpiar indicadores de llamada
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`llamadaP${i}`).classList.remove('activo');
            }
        }
        
        // ===============================
        // FUNCIONES AUXILIARES
        // ===============================
        
        function extraerPiso(texto) {
            const match = texto.match(/P(\d+)/);
            return match ? parseInt(match[1]) : null;
        }
        
        function extraerPisoDestino(texto) {
            // Busca patrones como "Destino P3" o "P3"
            const match = texto.match(/Destino P(\d+)|P(\d+)/);
            if (match) {
                return match[1] ? parseInt(match[1]) : parseInt(match[2]);
            }
            return null;
        }
        
        function mostrarLlamadaExterna(piso) {
            if (piso >= 1 && piso <= 3) {
                const indicador = document.getElementById(`llamadaP${piso}`);
                indicador.classList.add('activo');
                
                // Apagar despu茅s de 5 segundos
                setTimeout(() => {
                    indicador.classList.remove('activo');
                }, 5000);
            }
        }
        
        function mostrarOrdenInterna(piso) {
            // Destacar bot贸n interno
            const boton = document.getElementById(`btnInternal${piso}`);
            boton.classList.add('activo');
            
            setTimeout(() => {
                boton.classList.remove('activo');
            }, 3000);
        }
        
        function mostrarCuentaRegresiva(segundos) {
            let contador = segundos;
            const intervalo = setInterval(() => {
                if (contador > 0 && estadoSistema.puertas === 'ABIERTAS') {
                    document.getElementById('displayEstado').textContent = `PUERTAS ABIERTAS (${contador}s)`;
                    contador--;
                } else {
                    clearInterval(intervalo);
                }
            }, 1000);
        }
        
        function actualizarPanelMensajes(mensajes) {
            const container = document.getElementById('mensajesContainer');
            container.innerHTML = '';
            
            mensajes.forEach(mensaje => {
                const div = document.createElement('div');
                div.className = 'mensaje-item';
                
                const fecha = new Date(mensaje.ts);
                const hora = fecha.toLocaleTimeString();
                
                div.innerHTML = `
                    <div class="mensaje-header">
                        <div class="mensaje-time">
                            <i class="far fa-clock"></i> ${hora}
                        </div>
                        <div>Piso: ${mensaje.piso || '-'} | Estado: ${mensaje.estado || '-'}</div>
                    </div>
                    <div class="mensaje-content">${mensaje.mensaje || ''}</div>
                `;
                
                container.appendChild(div);
            });
        }
        
        function actualizarClaseMensaje(tipo) {
            const mensajes = document.querySelectorAll('.mensaje-item');
            if (mensajes.length > 0) {
                const ultimo = mensajes[0];
                ultimo.className = `mensaje-item ${tipo}`;
            }
        }
        
        function actualizarInterfaz() {
            // Actualizar estado del sistema en panel
            document.getElementById('systemStatus').textContent = 
                estadoSistema.emergencia ? 'EMERGENCIA' : 
                estadoSistema.movimiento !== 'DETENIDO' ? 'OPERANDO' : 'ESPERANDO';
        }
        
        function configurarControles() {
            // Configurar eventos para botones de simulaci贸n
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`btnCall${i}`).addEventListener('click', () => {
                    mostrarLlamadaExterna(i);
                });
                
                document.getElementById(`btnInternal${i}`).addEventListener('click', () => {
                    mostrarOrdenInterna(i);
                    
                    // Simular cambio de destino si est谩 detenido
                    if (estadoSistema.movimiento === 'DETENIDO') {
                        estadoSistema.pisoDestino = i;
                        document.getElementById('displayDestino').textContent = `Destino: P${i}`;
                    }
                });
            }
            
            // Bot贸n abrir puertas
            document.getElementById('btnOpenDoor').addEventListener('click', () => {
                if (!estadoSistema.emergencia) {
                    iniciarAperturaPuertas();
                }
            });
            
            // Bot贸n cerrar puertas
            document.getElementById('btnCloseDoor').addEventListener('click', () => {
                if (!estadoSistema.emergencia) {
                    cerrarPuertas();
                }
            });
            
            // Bot贸n emergencia
            document.getElementById('btnEmergency').addEventListener('click', () => {
                activarEmergencia();
            });
        }
        
        function mostrarMensajeInicial() {
            const container = document.getElementById('mensajesContainer');
            const div = document.createElement('div');
            div.className = 'mensaje-item inicio';
            div.innerHTML = `
                <div class="mensaje-header">
                    <div class="mensaje-time">
                        <i class="far fa-clock"></i> ${new Date().toLocaleTimeString()}
                    </div>
                    <div>Piso: 1 | Estado: 0</div>
                </div>
                <div class="mensaje-content">Sistema de simulaci贸n inicializado. Esperando conexi贸n con Firebase...</div>
            `;
            container.appendChild(div);
        }
    </script>
</body>
</html>
