<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor Ascensor - Firebase Tiempo Real</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<style>
body {
    font-family: Arial;
    background: #f5f5f5;
    padding: 20px;
}
table {
    width: 100%;
    background: white;
    border-collapse: collapse;
    margin-top: 20px;
}
th, td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
}
th {
    background: #333;
    color: white;
}
</style>
</head>

<body>

<h2>üì° Monitor Ascensor ‚Äì Mensajes en Tiempo Real</h2>
<h3>‚è± Hora local: Bolivia (GMT-4)</h3>

<table>
<thead>
<tr>
    <th>Fecha y hora (Bolivia)</th>
    <th>Piso</th>
    <th>Estado</th>
    <th>Mensaje</th>
</tr>
</thead>
<tbody id="tabla">
</tbody>
</table>

<script>
// =========================================
// CONFIG FIREBASE
// =========================================
const firebaseConfig = {
    apiKey: "AIzaSyAU31I1rNQCDLxG-ayjKS61uTo6oUuCmCA",
    authDomain: "monitor-ascensor.firebaseapp.com",
    databaseURL: "https://monitor-ascensor-default-rtdb.firebaseio.com",
    projectId: "monitor-ascensor",
    storageBucket: "monitor-ascensor.firebasestorage.app",
    messagingSenderId: "64032364230",
    appId: "1:64032364230:web:8afb090f6debefeccfa9c7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// =========================================
// FUNCI√ìN ‚Üí convertir TS ESP32 a hora Bolivia
// =========================================
function tsToBolivia(ts) {
    let fecha = new Date(ts);

    // Ajuste a Bolivia (GMT-4)
    let opciones = {
        timeZone: "America/La_Paz",
        hour12: false,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
    };
    return fecha.toLocaleString("es-BO", opciones);
}

// =========================================
// LISTENER TIEMPO REAL
// =========================================
db.ref("messages").on("value", (snap) => {
    const datos = snap.val();
    const tabla = document.getElementById("tabla");
    tabla.innerHTML = "";

    if (!datos) return;

    // Convertimos a array y ordenamos por timestamp (descendente)
    let arr = Object.values(datos).sort((a, b) => b.ts - a.ts);

    arr.forEach(msg => {
        let fila = `
            <tr>
                <td>${tsToBolivia(msg.ts)}</td>
                <td>${msg.piso}</td>
                <td>${msg.estado}</td>
                <td>${msg.mensaje}</td>
            </tr>
        `;
        tabla.innerHTML += fila;
    });
});
</script>

</body>
</html>
