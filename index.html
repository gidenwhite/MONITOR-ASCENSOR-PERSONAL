<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMULADOR DE ASCENSOR 3 PISOS - MONITOR EN TIEMPO REAL</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* (Mantener todo el CSS anterior igual - es perfecto) */
        /* ... TODO EL CSS ANTERIOR ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- PANEL DE MENSAJES - IZQUIERDA -->
        <div class="messages-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-comments"></i>
                    MENSAJES DEL ASCENSOR
                </div>
                <div class="connection-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="connectionText">Conectando...</span>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Los mensajes se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
            </div>
        </div>
        
        <!-- SIMULADOR DE ASCENSOR - DERECHA -->
        <div class="elevator-simulator">
            <!-- (Mantener todo el HTML del ascensor igual) -->
            <!-- ... TODO EL HTML DEL ASCENSOR ... -->
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACIÃ“N DE FIREBASE - CORREGIDA
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAU31I1rNQCDLxG-ayjKS61uTo6oUuCmCA",
            authDomain: "monitor-ascensor.firebaseapp.com",
            databaseURL: "https://monitor-ascensor-default-rtdb.firebaseio.com",
            projectId: "monitor-ascensor",
            storageBucket: "monitor-ascensor.firebasestorage.app",
            messagingSenderId: "64032364230",
            appId: "1:64032364230:web:8afb090f6debefeccfa9c7"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ============================================
        // VARIABLES DE ESTADO GLOBAL
        // ============================================
        const state = {
            currentFloor: 1,
            targetFloor: null,
            isMoving: false,
            direction: null,
            doorsOpen: false,
            emergency: false,
            externalCalls: [0, 0],
            internalCall: 0,
            doorTimer: null,
            movementTimer: null,
            connected: false,
            lastMessageTime: null,
            messageCount: 0,
            allMessages: [] // Para almacenar todos los mensajes
        };
        
        // ============================================
        // FUNCIONES DE MANEJO DE FIREBASE - CORREGIDAS
        // ============================================
        function initializeFirebase() {
            console.log("ðŸ”„ Inicializando conexiÃ³n Firebase...");
            
            // Referencia a la colecciÃ³n 'messages' (sin .json)
            const messagesRef = database.ref('messages');
            
            // ESCUCHAR NUEVOS MENSAJES
            messagesRef.on('child_added', (snapshot) => {
                if (!state.connected) {
                    updateConnectionStatus(true);
                    console.log("âœ… Conectado a Firebase - Primer mensaje recibido");
                }
                
                const message = snapshot.val();
                const messageId = snapshot.key;
                
                console.log("ðŸ“¥ Nuevo mensaje recibido:", {
                    id: messageId,
                    mensaje: message.mensaje,
                    piso: message.piso,
                    estado: message.estado,
                    ts: message.ts
                });
                
                // Agregar a lista de mensajes
                state.allMessages.push({
                    id: messageId,
                    ...message
                });
                
                // Ordenar por timestamp (mÃ¡s reciente primero)
                state.allMessages.sort((a, b) => b.ts - a.ts);
                
                // Mostrar en panel (mantener Ãºltimos 30)
                displayMessages(state.allMessages.slice(0, 30));
                
                // Procesar para simulaciÃ³n
                processMessageForSimulation(message);
                
                // Actualizar contador
                state.messageCount++;
                document.getElementById('connectionText').textContent = `${state.messageCount} msjs`;
                
            }, (error) => {
                console.error('âŒ Error en child_added:', error);
                updateConnectionStatus(false);
            });
            
            // ESCUCHAR CAMBIOS EN MENSAJES EXISTENTES
            messagesRef.on('child_changed', (snapshot) => {
                const updatedMessage = snapshot.val();
                const messageId = snapshot.key;
                
                console.log("ðŸ”„ Mensaje actualizado:", messageId, updatedMessage);
                
                // Actualizar en lista
                const index = state.allMessages.findIndex(m => m.id === messageId);
                if (index !== -1) {
                    state.allMessages[index] = { id: messageId, ...updatedMessage };
                    state.allMessages.sort((a, b) => b.ts - a.ts);
                    displayMessages(state.allMessages.slice(0, 30));
                    processMessageForSimulation(updatedMessage);
                }
            });
            
            // ESCUCHAR ELIMINACIÃ“N DE MENSAJES
            messagesRef.on('child_removed', (snapshot) => {
                const messageId = snapshot.key;
                state.allMessages = state.allMessages.filter(m => m.id !== messageId);
                displayMessages(state.allMessages.slice(0, 30));
            });
            
            // ERROR DE CONEXIÃ“N
            messagesRef.on('value', (snapshot) => {
                // Esta funciÃ³n se llama cuando hay cambios en la referencia completa
                if (snapshot.exists()) {
                    // Ya manejamos los mensajes individualmente con child_added
                } else {
                    displayMessage('ðŸ“­ No hay mensajes en la base de datos', 'system');
                }
            }, (error) => {
                console.error('ðŸ”¥ Error de conexiÃ³n Firebase:', error);
                updateConnectionStatus(false);
                displayMessage('âŒ Error de conexiÃ³n con Firebase. Verifica la consola.', 'emergency');
            });
        }
        
        function updateConnectionStatus(connected) {
            state.connected = connected;
            const statusDot = document.getElementById('statusDot');
            const connectionText = document.getElementById('connectionText');
            
            if (connected) {
                statusDot.classList.add('connected');
                connectionText.textContent = 'Conectado';
                connectionText.style.color = '#2ecc71';
                console.log("âœ… Estado: CONECTADO a Firebase");
            } else {
                statusDot.classList.remove('connected');
                connectionText.textContent = 'Desconectado';
                connectionText.style.color = '#e74c3c';
                console.log("âŒ Estado: DESCONECTADO de Firebase");
            }
        }
        
        // ============================================
        // FUNCIONES DE VISUALIZACIÃ“N DE MENSAJES - MEJORADAS
        // ============================================
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            // Solo actualizar si hay cambios
            if (messages.length === 0 && container.children.length === 0) return;
            
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const messageElement = createMessageElement(msg);
                container.appendChild(messageElement);
            });
            
            // Auto-scroll al inicio (mensajes mÃ¡s recientes)
            container.scrollTop = 0;
        }
        
        function displayMessage(text, type = 'system') {
            const container = document.getElementById('messagesContainer');
            const simulatedMessage = {
                id: 'sim_' + Date.now(),
                mensaje: text,
                ts: Date.now(),
                piso: state.currentFloor,
                estado: getEstadoFromType(type)
            };
            
            const messageElement = createMessageElement(simulatedMessage);
            container.insertBefore(messageElement, container.firstChild);
            
            // Limitar a 50 mensajes
            if (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }
        
        function createMessageElement(msg) {
            const element = document.createElement('div');
            element.className = 'message';
            element.dataset.id = msg.id;
            
            // Determinar tipo de mensaje
            const messageText = msg.mensaje || '';
            let messageType = 'system';
            
            if (messageText.includes('MOVIMIENTO') || messageText.includes('SUBIR') || 
                messageText.includes('BAJAR') || messageText.includes('Destino') ||
                messageText.includes('Motor')) {
                messageType = 'movement';
            } else if (messageText.includes('PUERTA') || messageText.includes('Apertura') || 
                      messageText.includes('cerradura') || messageText.includes('ventana')) {
                messageType = 'door';
            } else if (messageText.includes('EMERGENCIA') || messageText.includes('!!!') ||
                      messageText.includes('ERROR')) {
                messageType = 'emergency';
            } else if (messageText.includes('Llamada') || messageText.includes('INTERNA') ||
                      messageText.includes('Orden')) {
                messageType = 'call';
            } else if (messageText.includes('INICIO') || messageText.includes('AUTODIAGNÃ“STICO')) {
                messageType = 'system';
            }
            
            element.classList.add(`message-${messageType}`);
            
            // Formatear fecha y hora
            const timestamp = new Date();
            const timeString = timestamp.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const dateString = timestamp.toLocaleDateString('es-ES');
            
            // InformaciÃ³n adicional del mensaje
            const floorInfo = msg.piso ? `Piso: ${msg.piso}` : '';
            const stateInfo = msg.estado !== undefined ? `Estado: ${msg.estado}` : '';
            const extraInfo = [floorInfo, stateInfo].filter(Boolean).join(' | ');
            
            element.innerHTML = `
                <div class="message-header">
                    <div class="message-time">
                        <i class="far fa-clock"></i>
                        ${timeString} - ${dateString}
                    </div>
                    <div class="message-type">${messageType.toUpperCase()}</div>
                </div>
                <div class="message-content">
                    ${messageText}
                </div>
                ${extraInfo ? `<div class="message-extra">${extraInfo}</div>` : ''}
            `;
            
            return element;
        }
        
        function getEstadoFromType(type) {
            const estados = {
                'movement': 5, // MOVIMIENTO_SUBIENDO
                'door': 7,     // APERTURA_PUERTAS
                'emergency': 10, // EMERGENCIA
                'call': 2,     // ESPERA_PISOS
                'system': 0    // AUTODIAGNOSTICO
            };
            return estados[type] || 0;
        }
        
        // ============================================
        // FUNCIONES DE SIMULACIÃ“N - MANTENIDAS
        // ============================================
        // (MANTENER TODAS LAS FUNCIONES DE SIMULACIÃ“N ANTERIORES)
        // processMessageForSimulation, startMoving, arriveAtFloor, etc.
        // ... TODO EL CÃ“DIGO DE SIMULACIÃ“N ANTERIOR ...
        
        // ============================================
        // FUNCIONES UTILITARIAS
        // ============================================
        function extractFloorNumber(text) {
            // Buscar patrones: "P1", "Piso 1", "Destino P1"
            const patterns = [
                /P(\d+)/,                    // P1, P2, P3
                /Piso\s*(\d+)/,              // Piso 1
                /Destino\s*P?(\d+)/,         // Destino P1, Destino 1
                /slot\d+:\s*P?(\d+)/,        // slot1: P1
                /agregada.*P?(\d+)/          // agregada en slot1: P1
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const floor = parseInt(match[1]);
                    if (floor >= 1 && floor <= 3) {
                        console.log(`ðŸ“ ExtraÃ­do piso ${floor} de: "${text}"`);
                        return floor;
                    }
                }
            }
            
            console.warn(`âš  No se pudo extraer piso de: "${text}"`);
            return null;
        }
        
        function getStateFromMessage(msg) {
            if (msg.includes('MOVIMIENTO_SUBIENDO')) return 'SUBIENDO';
            if (msg.includes('MOVIMIENTO_BAJANDO')) return 'BAJANDO';
            if (msg.includes('APERTURA_PUERTAS')) return 'ABRIENDO PUERTAS';
            if (msg.includes('EMERGENCIA')) return 'EMERGENCIA';
            if (msg.includes('ESPERA')) return 'ESPERANDO';
            if (msg.includes('AUTODIAGNÃ“STICO')) return 'DIAGNÃ“STICO';
            return 'OPERANDO';
        }
        
        function getCabinStatusFromMessage(msg) {
            if (msg.includes('SUBIENDO')) return 'SUBIENDO';
            if (msg.includes('BAJANDO')) return 'BAJANDO';
            if (msg.includes('Llegado')) return 'LLEGADO';
            if (msg.includes('Apertura')) return 'ABRIENDO PUERTAS';
            if (msg.includes('EMERGENCIA')) return 'EMERGENCIA';
            if (msg.includes('SISTEMA LISTO')) return 'SISTEMA LISTO';
            return 'ESPERANDO';
        }
        
        // ============================================
        // PRUEBA DE CONEXIÃ“N DIRECTA
        // ============================================
        function testFirebaseConnection() {
            console.log("ðŸ§ª Probando conexiÃ³n Firebase...");
            
            // Intentar leer un dato de prueba
            const testRef = database.ref('.info/connected');
            testRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log("âœ… Firebase Database estÃ¡ conectado");
                } else {
                    console.log("âŒ Firebase Database estÃ¡ desconectado");
                }
            });
            
            // Verificar si hay mensajes
            const messagesRef = database.ref('messages');
            messagesRef.limitToLast(1).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        console.log("âœ… Hay mensajes en Firebase:", Object.keys(data).length);
                        console.log("ðŸ“ Ãšltimo mensaje:", Object.values(data)[0]);
                    } else {
                        console.log("ðŸ“­ No hay mensajes en Firebase");
                    }
                })
                .catch((error) => {
                    console.error("ðŸ”¥ Error al leer mensajes:", error);
                });
        }
        
        // ============================================
        // INICIALIZACIÃ“N MEJORADA
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ðŸš€ Iniciando simulador de ascensor...");
            
            // Mostrar mensaje inicial
            displayMessage('âš¡ Iniciando simulador de ascensor 3 pisos...', 'system');
            displayMessage('ðŸ“¡ Conectando a Firebase Realtime Database...', 'system');
            
            // Inicializar Firebase
            try {
                initializeFirebase();
                
                // Probar conexiÃ³n despuÃ©s de 2 segundos
                setTimeout(() => {
                    testFirebaseConnection();
                    
                    // Si despuÃ©s de 5 segundos no hay conexiÃ³n, mostrar advertencia
                    setTimeout(() => {
                        if (!state.connected && state.messageCount === 0) {
                            displayMessage('âš ï¸ No se han recibido mensajes de Firebase.', 'system');
                            displayMessage('ðŸ” Verifica que el ESP32 estÃ© enviando datos.', 'system');
                            displayMessage('ðŸ“¡ Ruta esperada: /messages', 'system');
                            console.warn("âš ï¸ No se han recibido mensajes. Posibles causas:");
                            console.warn("1. El ESP32 no estÃ¡ enviando datos");
                            console.warn("2. Problemas de red/firewall");
                            console.warn("3. Reglas de seguridad de Firebase");
                            console.warn("4. Ruta incorrecta en la base de datos");
                        }
                    }, 5000);
                }, 2000);
                
            } catch (error) {
                console.error("ðŸ’¥ Error crÃ­tico al inicializar Firebase:", error);
                displayMessage('ðŸ’¥ ERROR CRÃTICO: No se pudo inicializar Firebase', 'emergency');
                displayMessage('Detalle: ' + error.message, 'emergency');
            }
            
            // Configurar controles de simulaciÃ³n (igual que antes)
            // ... configuraciÃ³n de botones ...
        });
        
        // ============================================
        // FUNCIONES DE DEPURACIÃ“N
        // ============================================
        function debugLog(message, data = null) {
            const timestamp = new Date().toISOString().substr(11, 8);
            const logMessage = `[${timestamp}] ${message}`;
            
            console.log(logMessage);
            if (data) console.log(data);
            
            // TambiÃ©n mostrar en panel si es importante
            if (message.includes('ERROR') || message.includes('Falla')) {
                displayMessage(`ðŸ”§ ${message}`, 'system');
            }
        }
        
        // Exponer funciones para depuraciÃ³n en consola
        window.debug = {
            estado: () => state,
            mensajes: () => state.allMessages,
            reset: () => {
                state.allMessages = [];
                document.getElementById('messagesContainer').innerHTML = '';
                displayMessage('ðŸ§¹ DepuraciÃ³n: Mensajes reseteados', 'system');
            },
            simularMensaje: (texto) => {
                const mensajeSimulado = {
                    id: 'debug_' + Date.now(),
                    mensaje: texto,
                    ts: Date.now(),
                    piso: state.currentFloor,
                    estado: 2
                };
                processMessageForSimulation(mensajeSimulado);
                displayMessage(`ðŸ§ª Mensaje simulado: ${texto}`, 'system');
            }
        };
        
        console.log("ðŸ”§ DepuraciÃ³n disponible: usa window.debug.estado(), window.debug.mensajes(), etc.");
    </script>
    
    <!-- Estilos adicionales para depuraciÃ³n -->
    <style>
        .message-extra {
            font-size: 0.8rem;
            color: #95a5a6;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed rgba(255,255,255,0.1);
        }
        
        /* Indicador de estado de conexiÃ³n mÃ¡s visible */
        .connection-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s;
        }
        
        .connection-status:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.05);
        }
    </style>
</body>
</html>
