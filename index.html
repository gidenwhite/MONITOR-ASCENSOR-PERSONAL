<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Ascensor - Monitor Inteligente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a3a 0%, #0d1824 100%);
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Panel izquierdo - Mensajes Firebase */
        .messages-panel {
            width: 35%;
            background: rgba(10, 20, 30, 0.85);
            border-right: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 25px;
            overflow: hidden;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
        }

        .messages-panel h2 {
            color: #4fc3f7;
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(79, 195, 247, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .messages-panel h2 i {
            color: #ffb74d;
        }

        .firebase-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .firebase-status .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4caf50;
            box-shadow: 0 0 8px #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .message-item {
            background: rgba(30, 40, 50, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4fc3f7;
            animation: fadeIn 0.5s ease-out;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .message-item:hover {
            transform: translateY(-3px);
        }

        .message-time {
            font-size: 0.8rem;
            color: #90a4ae;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .message-content {
            font-size: 1rem;
            line-height: 1.4;
            color: #ffffff;
        }

        .message-movement {
            border-left-color: #81c784;
        }

        .message-door {
            border-left-color: #ffb74d;
        }

        .message-emergency {
            border-left-color: #f44336;
            animation: emergencyFlash 2s infinite;
        }

        @keyframes emergencyFlash {
            0%, 100% { background-color: rgba(30, 40, 50, 0.8); }
            50% { background-color: rgba(244, 67, 54, 0.3); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Panel derecho - Simulación del Ascensor */
        .elevator-panel {
            width: 65%;
            display: flex;
            flex-direction: column;
            padding: 25px;
            align-items: center;
        }

        .panel-title {
            color: #ffffff;
            font-size: 2.2rem;
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }

        .elevator-container {
            display: flex;
            width: 100%;
            max-width: 800px;
            background: rgba(20, 30, 40, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        /* Edificio y ascensor */
        .building {
            flex: 2;
            background: linear-gradient(to bottom, #2c3e50, #34495e);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 10px;
            border: 2px solid #1a252f;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        }

        .floor {
            flex: 1;
            border-bottom: 3px solid #7f8c8d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: relative;
        }

        .floor:last-child {
            border-bottom: none;
        }

        .floor-label {
            color: #ecf0f1;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 5px;
            min-width: 100px;
            text-align: center;
        }

        .floor-indicator {
            color: #3498db;
            font-weight: bold;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .elevator-shaft {
            position: absolute;
            right: 30px;
            top: 10px;
            bottom: 10px;
            width: 220px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #1a252f;
        }

        .elevator-cabin {
            position: absolute;
            bottom: 0;
            width: 200px;
            height: 180px;
            background: linear-gradient(to bottom, #bdc3c7, #95a5a6);
            left: 10px;
            border-radius: 8px;
            transition: bottom 2s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .elevator-roof {
            height: 15px;
            background: #34495e;
            border-bottom: 2px solid #2c3e50;
        }

        .elevator-display {
            height: 40px;
            background: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ecf0f1;
            font-weight: bold;
            font-size: 1.4rem;
            border-bottom: 2px solid #1a252f;
        }

        .elevator-display span {
            color: #2ecc71;
        }

        .elevator-doors {
            flex: 1;
            display: flex;
            position: relative;
        }

        .door {
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, #7f8c8d, #95a5a6);
            border: 2px solid #5d6d7e;
            transition: transform 2s ease-in-out;
            position: relative;
        }

        .door-left {
            transform-origin: left center;
            border-right: 1px solid #5d6d7e;
        }

        .door-right {
            transform-origin: right center;
            border-left: 1px solid #5d6d7e;
        }

        .door-handle {
            position: absolute;
            top: 50%;
            width: 10px;
            height: 30px;
            background: #d4ac0d;
            border-radius: 3px;
        }

        .door-left .door-handle {
            right: 15px;
            transform: translateY(-50%);
        }

        .door-right .door-handle {
            left: 15px;
            transform: translateY(-50%);
        }

        /* Panel de control */
        .control-panel {
            flex: 1;
            margin-left: 30px;
            background: rgba(30, 40, 50, 0.9);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .control-panel h3 {
            color: #4fc3f7;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
            border-bottom: 1px solid rgba(79, 195, 247, 0.3);
            padding-bottom: 10px;
        }

        .floor-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .floor-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            box-shadow: 0 5px 0 #1f618d;
        }

        .floor-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 0 #1f618d;
        }

        .floor-btn:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 #1f618d;
        }

        .door-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .door-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(to bottom, #ffb74d, #ff9800);
            color: #333;
            box-shadow: 0 4px 0 #e65100;
        }

        .door-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #e65100;
        }

        .emergency-section {
            margin-top: auto;
        }

        .emergency-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 6px 0 #922b21;
            letter-spacing: 1px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .emergency-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #922b21;
            background: linear-gradient(to bottom, #ff5a4a, #d43c2b);
        }

        .emergency-btn:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #922b21;
        }

        .status-indicators {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 25px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .status-value {
            color: #2ecc71;
            font-weight: bold;
        }

        /* Estados de emergencia */
        .emergency-active .elevator-cabin {
            animation: emergencyAlarm 1.5s infinite;
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }

        @keyframes emergencyAlarm {
            0%, 100% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.7); }
            50% { box-shadow: 0 0 40px rgba(231, 76, 60, 1); }
        }

        .emergency-message {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #e74c3c;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            text-align: center;
            padding: 15px;
            transform: translateY(-100%);
            transition: transform 0.5s;
            z-index: 100;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .emergency-active .emergency-message {
            transform: translateY(0);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            body {
                flex-direction: column;
            }
            
            .messages-panel, .elevator-panel {
                width: 100%;
            }
            
            .messages-panel {
                max-height: 40vh;
                border-right: none;
                border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            }
            
            .elevator-container {
                flex-direction: column;
            }
            
            .control-panel {
                margin-left: 0;
                margin-top: 30px;
            }
        }

        /* Estilos para botones activos */
        .active-floor {
            background: linear-gradient(to bottom, #2ecc71, #27ae60) !important;
            box-shadow: 0 5px 0 #1e8449 !important;
        }

        .active-call {
            animation: callBlink 1.5s infinite;
        }

        @keyframes callBlink {
            0%, 100% { background-color: rgba(52, 152, 219, 0.8); }
            50% { background-color: rgba(41, 128, 185, 1); }
        }

        /* Efectos visuales para movimiento */
        .moving-up {
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.8) !important;
        }

        .moving-down {
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8) !important;
        }
    </style>
</head>
<body>
    <!-- Panel izquierdo - Mensajes de Firebase -->
    <div class="messages-panel">
        <h2><i class="fas fa-broadcast-tower"></i> Panel de Monitoreo - Firebase</h2>
        
        <div class="firebase-status">
            <div>
                <strong>Estado Conexión:</strong>
                <span id="connection-status">Conectando...</span>
            </div>
            <div class="status-indicator" id="status-indicator"></div>
        </div>
        
        <div class="messages-container" id="messages-container">
            <!-- Los mensajes de Firebase aparecerán aquí -->
            <div class="message-item">
                <div class="message-time">Sistema | <span id="current-time">--:--:--</span></div>
                <div class="message-content">Esperando conexión con Firebase...</div>
            </div>
        </div>
    </div>
    
    <!-- Panel derecho - Simulación del Ascensor -->
    <div class="elevator-panel">
        <h1 class="panel-title">Sistema de Control de Ascensor</h1>
        
        <div class="elevator-container" id="elevator-container">
            <!-- Mensaje de emergencia -->
            <div class="emergency-message" id="emergency-message">
                <i class="fas fa-exclamation-triangle"></i> 
                EMERGENCIA ACTIVADA - SISTEMA DETENIDO 
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            
            <!-- Edificio y ascensor -->
            <div class="building">
                <!-- Piso 3 -->
                <div class="floor" id="floor-3">
                    <div class="floor-label">PISO 3</div>
                    <div class="floor-indicator" id="indicator-3">Disponible</div>
                </div>
                
                <!-- Piso 2 -->
                <div class="floor" id="floor-2">
                    <div class="floor-label">PISO 2</div>
                    <div class="floor-indicator" id="indicator-2">Disponible</div>
                </div>
                
                <!-- Piso 1 -->
                <div class="floor" id="floor-1">
                    <div class="floor-label">PISO 1</div>
                    <div class="floor-indicator" id="indicator-1">Disponible</div>
                </div>
                
                <!-- Hueco del ascensor -->
                <div class="elevator-shaft">
                    <div class="elevator-cabin" id="elevator-cabin">
                        <div class="elevator-roof"></div>
                        <div class="elevator-display" id="elevator-display">
                            PISO: <span id="current-floor">1</span>
                        </div>
                        <div class="elevator-doors">
                            <div class="door door-left" id="door-left"></div>
                            <div class="door door-right" id="door-right"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel de control -->
            <div class="control-panel">
                <h3><i class="fas fa-sliders-h"></i> Panel de Control</h3>
                
                <div class="floor-buttons">
                    <button class="floor-btn" data-floor="3">PISO 3</button>
                    <button class="floor-btn" data-floor="2">PISO 2</button>
                    <button class="floor-btn" data-floor="1">PISO 1</button>
                </div>
                
                <div class="door-controls">
                    <button class="door-btn" id="open-door-btn">
                        <i class="fas fa-door-open"></i> ABRIR PUERTAS
                    </button>
                    <button class="door-btn" id="close-door-btn">
                        <i class="fas fa-door-closed"></i> CERRAR PUERTAS
                    </button>
                </div>
                
                <div class="status-indicators">
                    <div class="status-item">
                        <span>Estado:</span>
                        <span class="status-value" id="elevator-status">ESPERANDO</span>
                    </div>
                    <div class="status-item">
                        <span>Destino:</span>
                        <span class="status-value" id="destination-display">--</span>
                    </div>
                    <div class="status-item">
                        <span>Puertas:</span>
                        <span class="status-value" id="door-status">CERRADAS</span>
                    </div>
                    <div class="status-item">
                        <span>Modo:</span>
                        <span class="status-value" id="mode-display">NORMAL</span>
                    </div>
                </div>
                
                <div class="emergency-section">
                    <button class="emergency-btn" id="emergency-btn">
                        <i class="fas fa-exclamation-triangle"></i> MODO EMERGENCIA
                    </button>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: center; color: #90a4ae; font-size: 0.9rem;">
            <p><i class="fas fa-info-circle"></i> Sistema de ascensor simulado con integración Firebase en tiempo real</p>
        </div>
    </div>

    <script>
        // Configuración de Firebase con las credenciales proporcionadas
        const firebaseConfig = {
            apiKey: "AIzaSyAU31I1rNQCDLxG-ayjKS61uTo6oUuCmCA",
            authDomain: "monitor-ascensor.firebaseapp.com",
            databaseURL: "https://monitor-ascensor-default-rtdb.firebaseio.com",
            projectId: "monitor-ascensor",
            storageBucket: "monitor-ascensor.firebasestorage.app",
            messagingSenderId: "64032364230",
            appId: "1:64032364230:web:8afb090f6debefeccfa9c7"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Variables de estado del ascensor
        let currentFloor = 1;
        let destinationFloor = null;
        let isMoving = false;
        let isDoorOpen = false;
        let isEmergencyMode = false;
        let movementDirection = null; // 'up' o 'down'
        let doorTimer = null;
        let externalCalls = {1: false, 2: false, 3: false};
        let internalOrders = {1: false, 2: false, 3: false};
        
        // Referencias a elementos DOM
        const elevatorCabin = document.getElementById('elevator-cabin');
        const elevatorDisplay = document.getElementById('elevator-display');
        const currentFloorSpan = document.getElementById('current-floor');
        const doorLeft = document.getElementById('door-left');
        const doorRight = document.getElementById('door-right');
        const elevatorContainer = document.getElementById('elevator-container');
        const emergencyMessage = document.getElementById('emergency-message');
        const messagesContainer = document.getElementById('messages-container');
        const connectionStatus = document.getElementById('connection-status');
        const statusIndicator = document.getElementById('status-indicator');
        const elevatorStatus = document.getElementById('elevator-status');
        const destinationDisplay = document.getElementById('destination-display');
        const doorStatus = document.getElementById('door-status');
        const modeDisplay = document.getElementById('mode-display');
        const currentTimeSpan = document.getElementById('current-time');
        
        // Configurar altura de los pisos (en píxeles)
        const floorHeight = 180; // Altura de cada piso (igual a la altura de la cabina)
        
        // Inicializar la posición del ascensor
        updateElevatorPosition();
        
        // Actualizar la hora actual
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            currentTimeSpan.textContent = timeString;
        }
        
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // Conectar a Firebase y escuchar mensajes
        function initializeFirebase() {
            const messagesRef = database.ref('messages');
            
            messagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                addMessageToPanel(message);
                processFirebaseMessage(message);
            });
            
            // Verificar conexión
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    connectionStatus.textContent = "Conectado";
                    connectionStatus.style.color = "#4caf50";
                    statusIndicator.style.backgroundColor = "#4caf50";
                    statusIndicator.style.boxShadow = "0 0 8px #4caf50";
                    
                    // Agregar mensaje de conexión exitosa
                    addSystemMessage("Conexión Firebase establecida. Sistema operativo.");
                } else {
                    connectionStatus.textContent = "Desconectado";
                    connectionStatus.style.color = "#f44336";
                    statusIndicator.style.backgroundColor = "#f44336";
                    statusIndicator.style.boxShadow = "0 0 8px #f44336";
                }
            });
            
            // Agregar mensaje inicial del sistema
            addSystemMessage("=== INICIO SISTEMA ASCENSOR 3 PISOS - CONFIGURACION ESTRICTA ===");
            setTimeout(() => {
                addSystemMessage("=== AUTODIAGNÓSTICO OK ===");
                elevatorStatus.textContent = "OPERATIVO";
            }, 1500);
        }
        
        // Agregar mensaje al panel
        function addMessageToPanel(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-item';
            
            // Determinar clase CSS según el tipo de mensaje
            if (message.text.includes("EMERGENCIA") || message.text.includes("emergencia")) {
                messageDiv.classList.add('message-emergency');
            } else if (message.text.includes("SUBIR") || message.text.includes("BAJAR") || 
                       message.text.includes("MOVIMIENTO") || message.text.includes("Destino")) {
                messageDiv.classList.add('message-movement');
            } else if (message.text.includes("PUERTAS") || message.text.includes("puertas") || 
                       message.text.includes("APERTURA") || message.text.includes("CERRANDO")) {
                messageDiv.classList.add('message-door');
            }
            
            const time = new Date(message.timestamp || Date.now()).toLocaleTimeString();
            const date = new Date(message.timestamp || Date.now()).toLocaleDateString();
            
            messageDiv.innerHTML = `
                <div class="message-time">${date} | ${time}</div>
                <div class="message-content">${message.text}</div>
            `;
            
            messagesContainer.prepend(messageDiv);
            
            // Limitar a 50 mensajes
            const allMessages = messagesContainer.querySelectorAll('.message-item');
            if (allMessages.length > 50) {
                messagesContainer.removeChild(allMessages[allMessages.length - 1]);
            }
            
            // Auto-scroll al nuevo mensaje
            messagesContainer.scrollTop = 0;
        }
        
        // Agregar mensaje del sistema (sin Firebase)
        function addSystemMessage(text) {
            const message = {
                text: text,
                timestamp: Date.now()
            };
            addMessageToPanel(message);
        }
        
        // Procesar mensaje de Firebase y sincronizar con el ascensor
        function processFirebaseMessage(message) {
            const text = message.text;
            
            // 1. MENSAJES DE MOVIMIENTO - SUBIR/BAJAR
            if (text.includes("[ESTADO_MOVIMIENTO_SUBIENDO]") || text.includes("[ESTADO_MOVIMIENTO_BAJANDO]")) {
                // Extraer el piso destino del mensaje
                const floorMatch = text.match(/Destino P(\d)/);
                if (floorMatch) {
                    const destination = parseInt(floorMatch[1]);
                    destinationFloor = destination;
                    destinationDisplay.textContent = `PISO ${destination}`;
                    
                    // Determinar dirección
                    movementDirection = text.includes("SUBIENDO") ? "up" : "down";
                    
                    // Cerrar puertas si están abiertas
                    if (isDoorOpen) {
                        closeDoors();
                        setTimeout(() => {
                            moveToFloor(destination);
                        }, 2000);
                    } else {
                        moveToFloor(destination);
                    }
                    
                    // Actualizar estado
                    elevatorStatus.textContent = movementDirection === "up" ? "SUBIENDO" : "BAJANDO";
                    addSystemMessage(`Ascensor ${movementDirection === "up" ? "subiendo" : "bajando"} hacia PISO ${destination}`);
                }
            }
            
            // 2. LLEGADA A PISO Y APERTURA DE PUERTAS
            else if (text.includes("Llegado a Piso") && text.includes("Transicion a APERTURA_PUERTAS")) {
                // Extraer el piso del mensaje
                const floorMatch = text.match(/Piso (\d)/);
                if (floorMatch) {
                    const floor = parseInt(floorMatch[1]);
                    
                    // Detener movimiento y posicionar exactamente
                    isMoving = false;
                    currentFloor = floor;
                    updateElevatorPosition();
                    
                    // Esperar 0.5 segundos y abrir puertas
                    setTimeout(() => {
                        openDoors();
                        elevatorStatus.textContent = "ABRIENDO PUERTAS";
                    }, 500);
                    
                    addSystemMessage(`Ascensor llegó al PISO ${floor}. Preparando apertura de puertas.`);
                }
            }
            
            // 3. SECUENCIA COMPLETA DE APERTURA
            else if (text.includes("[ESTADO_APERTURA_PUERTAS]")) {
                // Confirmar que estamos en estado de apertura
                elevatorStatus.textContent = "ABRIENDO PUERTAS";
                addSystemMessage("Proceso de apertura de puertas confirmado.");
            }
            
            else if (text.includes("Apertura: Activando relé(s) de cerradura por 10000 ms")) {
                addSystemMessage("Cerraduras desbloqueadas - Iniciando apertura.");
            }
            
            else if (text.includes("Relés de cerradura DESACTIVADOS")) {
                // Puertas completamente abiertas
                isDoorOpen = true;
                doorStatus.textContent = "ABIERTAS";
                elevatorStatus.textContent = "PUERTAS ABIERTAS - ESPERANDO";
                addSystemMessage("Puertas completamente abiertas. Iniciando temporizador de espera (10s).");
                
                // Iniciar temporizador para cerrar puertas automáticamente
                clearTimeout(doorTimer);
                doorTimer = setTimeout(() => {
                    if (!isEmergencyMode) {
                        closeDoors();
                        addSystemMessage("Fin de ventana de puertas - Cerrando automáticamente.");
                    }
                }, 10000);
            }
            
            // 4. EMERGENCIA
            else if (text.includes("!!! ENTRANDO EN ESTADO_EMERGENCIA:")) {
                activateEmergencyMode(text);
            }
            
            else if (text.includes("[ESTADO_EMERGENCIA] Sistema detenido. Esperar reinicio físico.")) {
                // Confirmar estado de emergencia
                elevatorStatus.textContent = "EMERGENCIA - BLOQUEADO";
                modeDisplay.textContent = "EMERGENCIA";
                addSystemMessage("Sistema bloqueado en modo emergencia. Requiere reinicio físico.");
            }
            
            // 5. LLAMADAS Y ÓRDENES
            else if (text.includes("Llamada externa agregada en slot")) {
                // Extraer el piso del mensaje
                const floorMatch = text.match(/PX: P(\d)/) || text.match(/P(\d)/);
                if (floorMatch) {
                    const floor = parseInt(floorMatch[1]);
                    externalCalls[floor] = true;
                    updateFloorIndicator(floor, "external");
                    addSystemMessage(`Llamada externa registrada para PISO ${floor}`);
                    
                    // Si el ascensor está en espera, moverse al piso llamado
                    if (!isMoving && !isDoorOpen && !isEmergencyMode && destinationFloor === null) {
                        destinationFloor = floor;
                        moveToFloor(floor);
                    }
                }
            }
            
            else if (text.includes("Orden INTERNA detectada en ESPERA:")) {
                // Extraer el piso del mensaje
                const floorMatch = text.match(/PX: P(\d)/) || text.match(/P(\d)/);
                if (floorMatch) {
                    const floor = parseInt(floorMatch[1]);
                    internalOrders[floor] = true;
                    updateFloorIndicator(floor, "internal");
                    addSystemMessage(`Orden interna registrada para PISO ${floor}`);
                    
                    // Tiene prioridad absoluta
                    if (!isEmergencyMode) {
                        destinationFloor = floor;
                        
                        if (isDoorOpen) {
                            closeDoors();
                            setTimeout(() => {
                                moveToFloor(floor);
                            }, 2000);
                        } else if (!isMoving) {
                            moveToFloor(floor);
                        } else {
                            // Recalcular destino si ya se está moviendo
                            addSystemMessage(`Recalculando destino. Nueva prioridad: PISO ${floor}`);
                        }
                    }
                }
            }
            
            // 6. INICIO Y REINICIO DEL SISTEMA
            else if (text.includes("=== INICIO SISTEMA ASCENSOR 3 PISOS - CONFIGURACION ESTRICTA ===")) {
                resetElevatorSystem();
                addSystemMessage("Sistema de ascensor reiniciado a configuración inicial.");
            }
            
            else if (text.includes("=== AUTODIAGNÓSTICO OK ===")) {
                elevatorStatus.textContent = "OPERATIVO";
                modeDisplay.textContent = "NORMAL";
                addSystemMessage("Autodiagnóstico completado. Sistema listo para operar.");
            }
            
            // Relé SUBIR/BAJAR = HIGH (activado)
            else if (text.includes("Relé SUBIR = HIGH") || text.includes("Relé BAJAR = HIGH")) {
                // Efecto visual para confirmar motor activado
                elevatorCabin.classList.add(movementDirection === "up" ? "moving-up" : "moving-down");
                addSystemMessage("Motor de movimiento activado.");
            }
        }
        
        // Mover el ascensor a un piso específico
        function moveToFloor(floor) {
            if (isEmergencyMode || floor === currentFloor) return;
            
            isMoving = true;
            destinationFloor = floor;
            destinationDisplay.textContent = `PISO ${floor}`;
            
            // Determinar dirección
            movementDirection = floor > currentFloor ? "up" : "down";
            elevatorStatus.textContent = movementDirection === "up" ? "SUBIENDO" : "BAJANDO";
            
            // Actualizar display de la cabina
            const displayText = movementDirection === "up" ? `SUBIENDO → P${floor}` : `BAJANDO → P${floor}`;
            elevatorDisplay.innerHTML = `${displayText}`;
            
            // Calcular distancia y tiempo de animación
            const distance = Math.abs(floor - currentFloor);
            const duration = distance * 2000; // 2 segundos por piso
            
            // Actualizar posición visual
            const newBottom = (floor - 1) * floorHeight;
            elevatorCabin.style.transition = `bottom ${duration}ms ease-in-out`;
            elevatorCabin.style.bottom = `${newBottom}px`;
            
            // Actualizar estado cuando termine el movimiento
            setTimeout(() => {
                isMoving = false;
                currentFloor = floor;
                currentFloorSpan.textContent = floor;
                
                // Actualizar display
                elevatorDisplay.innerHTML = `PISO: <span id="current-floor">${floor}</span>`;
                
                // Llegada a piso
                elevatorStatus.textContent = "LLEGADA A PISO";
                addSystemMessage(`Llegado a Piso ${floor} (${movementDirection}). Transicion a APERTURA_PUERTAS`);
                
                // Limpiar efectos visuales de movimiento
                elevatorCabin.classList.remove("moving-up", "moving-down");
                
                // Esperar y abrir puertas automáticamente
                setTimeout(() => {
                    if (!isEmergencyMode) {
                        openDoors();
                        elevatorStatus.textContent = "ABRIENDO PUERTAS";
                        
                        // Limpiar llamadas/órdenes para este piso
                        if (externalCalls[floor]) {
                            externalCalls[floor] = false;
                            updateFloorIndicator(floor, "clear");
                        }
                        if (internalOrders[floor]) {
                            internalOrders[floor] = false;
                            updateFloorIndicator(floor, "clear");
                        }
                    }
                }, 500);
                
                destinationFloor = null;
                destinationDisplay.textContent = "--";
                
            }, duration);
        }
        
        // Actualizar posición visual del ascensor
        function updateElevatorPosition() {
            const bottom = (currentFloor - 1) * floorHeight;
            elevatorCabin.style.bottom = `${bottom}px`;
            currentFloorSpan.textContent = currentFloor;
        }
        
        // Abrir puertas
        function openDoors() {
            if (isEmergencyMode) return;
            
            doorLeft.style.transform = "translateX(-95%)";
            doorRight.style.transform = "translateX(95%)";
            isDoorOpen = true;
            doorStatus.textContent = "ABIERTAS";
            
            // Si hay un temporizador de cierre automático, limpiarlo
            clearTimeout(doorTimer);
            
            addSystemMessage("[ESTADO_APERTURA_PUERTAS] Puertas abriéndose");
            
            // Después de 3 segundos, confirmar apertura completa
            setTimeout(() => {
                if (isDoorOpen && !isEmergencyMode) {
                    addSystemMessage("Relés de cerradura DESACTIVADOS - Puertas completamente abiertas");
                    addSystemMessage("Puertas abiertas (esperando) por 10000 ms");
                    
                    // Iniciar temporizador de cierre automático (10 segundos)
                    doorTimer = setTimeout(() => {
                        if (!isEmergencyMode) {
                            closeDoors();
                            addSystemMessage("Fin de ventana de puertas - Cerrando automáticamente.");
                        }
                    }, 10000);
                }
            }, 3000);
        }
        
        // Cerrar puertas
        function closeDoors() {
            if (isEmergencyMode) return;
            
            doorLeft.style.transform = "translateX(0)";
            doorRight.style.transform = "translateX(0)";
            isDoorOpen = false;
            doorStatus.textContent = "CERRADAS";
            elevatorStatus.textContent = "ESPERANDO";
            
            // Limpiar temporizador de cierre automático
            clearTimeout(doorTimer);
            
            addSystemMessage("Puertas cerradas - Sistema listo para movimiento.");
        }
        
        // Activar modo emergencia
        function activateEmergencyMode(reason) {
            isEmergencyMode = true;
            isMoving = false;
            
            // Aplicar estilos de emergencia
            elevatorContainer.classList.add("emergency-active");
            
            // Detener cualquier movimiento
            elevatorCabin.style.transition = "none";
            
            // Mostrar mensaje de emergencia
            const reasonText = reason.split(":")[1] || "Razón no especificada";
            emergencyMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 
                EMERGENCIA ACTIVADA - ${reasonText.toUpperCase()} 
                <i class="fas fa-exclamation-triangle"></i>`;
            
            // Actualizar estado
            elevatorStatus.textContent = "EMERGENCIA";
            modeDisplay.textContent = "EMERGENCIA";
            destinationDisplay.textContent = "--";
            
            // Desactivar todos los controles
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
            });
            
            addSystemMessage(`!!! ENTRANDO EN ESTADO_EMERGENCIA: ${reasonText}`);
            addSystemMessage("[ESTADO_EMERGENCIA] Sistema detenido. Esperar reinicio físico.");
        }
        
        // Desactivar modo emergencia
        function deactivateEmergencyMode() {
            isEmergencyMode = false;
            
            // Quitar estilos de emergencia
            elevatorContainer.classList.remove("emergency-active");
            
            // Reactivar controles
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
            });
            
            // Actualizar estado
            elevatorStatus.textContent = "OPERATIVO";
            modeDisplay.textContent = "NORMAL";
            
            addSystemMessage("Modo emergencia desactivado. Sistema reiniciado.");
        }
        
        // Actualizar indicadores de piso
        function updateFloorIndicator(floor, type) {
            const indicator = document.getElementById(`indicator-${floor}`);
            
            if (type === "external") {
                indicator.textContent = "LLAMADA EXTERNA";
                indicator.style.color = "#3498db";
                indicator.parentElement.classList.add("active-call");
            } else if (type === "internal") {
                indicator.textContent = "ORDEN INTERNA";
                indicator.style.color = "#2ecc71";
                indicator.parentElement.classList.add("active-call");
            } else {
                indicator.textContent = "Disponible";
                indicator.style.color = "#3498db";
                indicator.parentElement.classList.remove("active-call");
            }
        }
        
        // Reiniciar sistema del ascensor
        function resetElevatorSystem() {
            // Detener todo
            isMoving = false;
            isEmergencyMode = false;
            destinationFloor = null;
            
            // Cerrar puertas
            closeDoors();
            
            // Posicionar en piso 1
            currentFloor = 1;
            updateElevatorPosition();
            
            // Limpiar indicadores
            for (let i = 1; i <= 3; i++) {
                externalCalls[i] = false;
                internalOrders[i] = false;
                updateFloorIndicator(i, "clear");
            }
            
            // Restablecer controles
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
            });
            
            // Quitar modo emergencia
            elevatorContainer.classList.remove("emergency-active");
            
            // Actualizar displays
            elevatorStatus.textContent = "OPERATIVO";
            modeDisplay.textContent = "NORMAL";
            destinationDisplay.textContent = "--";
            currentFloorSpan.textContent = "1";
            elevatorDisplay.innerHTML = `PISO: <span id="current-floor">1</span>`;
        }
        
        // Event listeners para controles manuales
        document.querySelectorAll('.floor-btn').forEach(button => {
            button.addEventListener('click', function() {
                if (isEmergencyMode) return;
                
                const floor = parseInt(this.getAttribute('data-floor'));
                
                // Si el ascensor está en movimiento o las puertas están abiertas, registrar como orden interna
                if (isMoving || isDoorOpen) {
                    internalOrders[floor] = true;
                    updateFloorIndicator(floor, "internal");
                    addSystemMessage(`Orden INTERNA detectada en ESPERA: P${floor}`);
                    
                    // Si las puertas están abiertas, cerrarlas primero
                    if (isDoorOpen) {
                        closeDoors();
                        setTimeout(() => {
                            destinationFloor = floor;
                            moveToFloor(floor);
                        }, 2000);
                    }
                } else {
                    // Si está esperando, mover directamente
                    destinationFloor = floor;
                    moveToFloor(floor);
                }
            });
        });
        
        document.getElementById('open-door-btn').addEventListener('click', function() {
            if (!isEmergencyMode && !isMoving) {
                openDoors();
            }
        });
        
        document.getElementById('close-door-btn').addEventListener('click', function() {
            if (!isEmergencyMode && !isMoving) {
                closeDoors();
            }
        });
        
        document.getElementById('emergency-btn').addEventListener('click', function() {
            if (isEmergencyMode) {
                deactivateEmergencyMode();
                this.innerHTML = '<i class="fas fa-exclamation-triangle"></i> MODO EMERGENCIA';
            } else {
                activateEmergencyMode("Activado manualmente desde panel de control");
                this.innerHTML = '<i class="fas fa-undo"></i> REINICIAR SISTEMA';
            }
        });
        
        // Inicializar Firebase cuando se cargue la página
        window.addEventListener('DOMContentLoaded', initializeFirebase);
        
        // Agregar algunos mensajes de ejemplo para demostración
        setTimeout(() => {
            if (messagesContainer.querySelectorAll('.message-item').length <= 2) {
                addSystemMessage("Sistema listo para recibir comandos de Firebase.");
                addSystemMessage("Simulación de llamada externa: PISO 3");
                addSystemMessage("Llamada externa agregada en slot1: P3");
                
                // Simular una llamada externa al piso 3 después de 3 segundos
                setTimeout(() => {
                    if (!isEmergencyMode) {
                        externalCalls[3] = true;
                        updateFloorIndicator(3, "external");
                        
                        // Si el ascensor está en espera, moverse al piso 3
                        if (!isMoving && !isDoorOpen && destinationFloor === null) {
                            setTimeout(() => {
                                destinationFloor = 3;
                                moveToFloor(3);
                            }, 1000);
                        }
                    }
                }, 3000);
            }
        }, 2000);
    </script>
</body>
</html>
